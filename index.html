<!DOCTYPE html>
<html>
  <head>
    <title>Scheduler for FB</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
      * { box-sizing: border-box; }
      html, body { margin: 0; padding: 0; }
      body { font-family: Helvetica, Arial, sans-serif; color: #444; }
      .main { padding: 1em; max-width: 700px; margin-left: auto; margin-right: auto; }
      #pages, #posts { display: none; }
      #pages:target, #posts:target { display: block; }

      .login-container { text-align: center; }

      .page { padding: 1em; display: flex; align-items: center; }
      .page + .page { border-top: 1px solid #ddd; }
      .page:hover { background: #eee; }
      .page-name { padding-left: 1em; }

      .current-page-name { position: fixed; top: 0; width: 100%; max-width: 700px; background: #fff; padding-top: 0.67em; padding-bottom: 0.67em; margin: 0; }
      #posts { padding-top: 3em; }

      .posts { width: 100%; border-collapse: collapse; }
      .posts th { text-align: left; font-size: 1.7em; padding-top: 1em; padding-bottom: .5em; }
      .post > td { padding: 1em; border-top: 1px solid #eee; }
      .post.available { background: lightgreen; padding-left: 1em; }
      .post.overlaps > .post-time { color: red; }
      .post-text { width: 100%; }
      .post-text-content { max-height: 2.3em; overflow: hidden; text-overflow: ellipsis; }
      .post-picture { float: left; max-width: 40px; max-height: 40px; margin-right: 10px; margin-bottom: 10px; }
      .post-author { color: #999; }
      .post-opener { display: none; }
      .post-opener:checked + .post-text-content { max-height: 9999em; }
    </style>
  </head>
  <body>
    <div class="main">
      <div id="login">
        <h2>Entra con il tuo account Facebook per vedere i post programmati</h2>
        <p class="login-container">
          <span id="wait-for-fb">Caricamento pulsante...</span>
          <fb:login-button scope="public_profile,manage_pages" onlogin="checkLoginState();" data-size="xlarge">
          </fb:login-button>
        </p>
        <p id="message"></p>
      </div>

      <div id="pages"></div>
      <div id="posts"></div>
    </div>

    <script>
      var state = {
        page: null,
        pages: {},
        posts: [],
        firstHour: 8,
        lastHour: 22,
        lastDate: new Date()
      };


      window.onscroll = function () {
        if (!state.page)
          return;

        var totalHeight = document.body.offsetHeight;
        var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        var scrollY = window.scrollY;
        var threshold = viewportHeight;
        var upperBound = totalHeight - viewportHeight - threshold;
        if (scrollY > upperBound)
          renderPosts();
      };


      function statusChangeCallback(response) {
        if (response.status == 'connected') {
          document.getElementById('login').style.display = 'none';
          getPages();
        } else if (response.status == 'not_authorized') {
          askToLogInApp();
        } else {
          askToLogToFacebook();
        }
      }


      function askToLogInApp() {
        document.getElementById('message').innerHTML = 'Please log in to app';
      }

      function askToLogToFacebook() {
        document.getElementById('message').innerHTML = 'Please log in to Facebook';
      }

      function getPages() {
        window.location = '#pages';
        document.getElementById('message').innerHTML = 'Welcome! Fetching your information...';
        FB.api('/me/accounts', function(response) {
          var pages = response.data;
          document.getElementById('pages').innerHTML = 
            '<h2>Quale pagina vuoi usare?</h2>' +
            pages
              .sort(function (p1, p2) { return p1.name.toLowerCase().localeCompare(p2.name.toLowerCase()); })
              .map(function (page) {
                state.pages[page.id] = page;
                return '<div class="page" data-page-id="' + page.id + '">' +
                  '<image class="page-picture" src="//graph.facebook.com/' + page.id + '/picture" style="width:50px;height:50px">' +
                  '<div class="page-name">' + page.name + '</div>' +
                '</div>'
              }).join('') || 'No page found';
          document.getElementById('message').innerHTML = 'Thanks for logging in, ' + response.name + '!';
        });
      }

      addListener(document.body, 'click', '[data-page-id]', function(e) {
        var target = this;
        var pageId = target.dataset.pageId;
        getScheduledPosts(pageId);
      });


      function getScheduledPosts(pageId) {
        var page = state.pages[pageId];
        var params = { 
          fields: 'scheduled_publish_time,admin_creator,message,picture',
          limit: 100,
          is_published: false
        };
        state.page = page;
        if (page)
          params.access_token = page.access_token;


        if (location.hash != '#posts')
          window.location = '#posts';
        disableBtns(document.querySelectorAll('button[data-page-id="' + pageId + '"]'));
        state.posts = [];

        FB.api(
          '/' + pageId + '/promotable_posts',
          params, 
          receivedPosts);
      }

      function receivedPosts(response) {
        var posts = response.data;
        state.posts = state.posts
          .concat(posts)
          .sort(function (p1, p2) { 
            return p1.scheduled_publish_time - p2.scheduled_publish_time; 
          });
        renderPosts();

        if (posts.length && response.paging.next)
          FB.api(response.paging.next, receivedPosts);
        else
          enableBtns(document.querySelectorAll('button[data-page-id="' + state.page.id + '"]'));
      }

      function renderPosts() {
        var posts = state.posts;
        var lastDate;
        var scheduledSlots = getScheduledSlots(posts);
        var fromDate = new Date();
        fromDate.setHours(fromDate.getHours() + 1);
        var toDate = getLastDate(posts);
        var availableSlots = getAvailableSlots(fromDate, toDate, scheduledSlots);
        var allSlots = posts
          .concat(availableSlots)
          .sort(function(s1, s2) { 
            return s1.scheduled_publish_time - s2.scheduled_publish_time ||
              (s1.id < s2.id ? -1 :
                s1.id > s2.id ? 1 :
                0); 
          });


        document.getElementById('posts').innerHTML = 
          (state.page ? '<h1 class="current-page-name">' + state.page.name + ' (' + state.posts.length + ') <button class="refresh-posts" data-page-id="' + state.page.id + '">Ricarica</button></h1>' : '') +
              '<table class="posts"><tbody>' +
              allSlots
              .map(function (post, i, posts) {
                var scheduledDate = new Date(post.scheduled_publish_time * 1000);
                var labelDate = formatDate(scheduledDate);
                var creator = post.admin_creator;
                var dateH = '';
                var isAvailable = !post.id;

                if (labelDate !== lastDate) {
                  dateH = '<tr><th colspan="2">' + labelDate + '</th></tr>';
                  lastDate = labelDate;
                }

                return dateH + 
                  '<tr class="post' + (isAvailable ? ' available' : '') + (post.overlaps ? ' overlaps' : '') + '">' + 
                    '<td class="post-time">' + formatTime(scheduledDate) + '</td>' +
                    '<td class="post-text">' +
                      '<input class="post-opener" type="checkbox" id="post-' + post.id + '">' +
                      '<div class="post-text-content">' + 
                        (isAvailable ? 'Disponibile per pubblicazione' : 
                          (post.picture ? '<img class="post-picture" src="' + post.picture + '">' : '') +
                          '<span class="post-author">' + (creator && creator.name) + '</span><br>' +
                          '<label for="post-' + post.id + '">' + (post.message || '<i>---</i>').replace(/\n/g, '<br>') + '</label>'
                        ) +
                      '</div>' +
                    '</td>'
                  '</tr>';
              }).join('') || 'No scheduled posts' +
              '</tbody></table>';
        
        var title = document.querySelector('.current-page-name');
        if (title) {
          var titleH = title.offsetHeight;
          document.querySelector('#posts').style.paddingTop = (titleH + 10) + 'px';
        }
      }


      function getAvailableSlots(fromDate, toDate, scheduledSlots) {
        var slots = [];
        for (var cursorDate = truncDate(fromDate); cursorDate.getTime() < toDate.getTime(); cursorDate.setHours(cursorDate.getHours() + 1)) {
          if (cursorDate.getHours() < state.firstHour) {
            cursorDate.setHours(state.firstHour);
          } else if (cursorDate.getHours() > state.lastHour) {
            cursorDate.setDate(cursorDate.getDate() + 1);
            cursorDate.setHours(state.firstHour - 1);
            continue;
          }

          var index = getDateSlot(cursorDate);
          var isBusy = scheduledSlots.hasOwnProperty(index);
          if (!isBusy)
            slots.push({ scheduled_publish_time: Math.round(cursorDate.getTime() / 1000) });
        }
        return slots;
      }

      function getScheduledSlots(posts) {
        return posts.reduce(function(slots, post) {
          var index = getDateSlot(new Date(post.scheduled_publish_time * 1000));
          var overlaps = slots.hasOwnProperty(index);
          if (overlaps)
            slots[index].overlaps = overlaps;
          post.overlaps = overlaps;
          slots[index] = post;
          return slots;
        }, {});
      }

      function getLastDate(posts) {
        var lastDate = state.lastDate;
        lastDate.setDate(lastDate.getDate() + 5);

        var dates = posts.map(function (post) { return post.scheduled_publish_time; });
        if (dates.length) {
          var lastPostTime = Math.max.apply(Math, dates);
          var lastPostDate = new Date(lastPostTime * 1000);
          if (lastPostDate.getTime() > lastDate.getTime())
            lastDate = lastPostDate;
        }
        
        return lastDate;
      }


      function getDateSlot(date) {
        var truncated = truncDate(date);
        return formatDate(truncated) + ' ' + formatTime(truncated);
      }

      function truncDate(date) {
        var truncated = new Date(date);
        truncated.setMinutes(0);
        truncated.setSeconds(0);
        truncated.setMilliseconds(0);
        return truncated;
      }

      function formatDate(date) {
        return date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear();
      }

      function formatTime(date) {
        return pad(date.getHours()) + ':' + pad(date.getMinutes());
      }

      function pad(num) {
        return ('0' + num).substr(-2);
      }

      function addListener(el, eventName, delegate, callback) {
        el.addEventListener(eventName, function(e) {
          var target = e.target;
          while (target) {
            if (!target.matches)
              return;
            if (target.matches(delegate))
              break;
            target = target.parentNode;
          }

          if (!target)
            return;

          callback.call(target, e);
        }, false);
      }

      function disableBtns(buttons) {
        for (var i = 0; i < buttons.length; i++)
          buttons[i].disabled = true;
      }

      function enableBtns(buttons) {
        for (var i = 0; i < buttons.length; i++)
          buttons[i].disabled = false;
      }


      function checkLoginState() {
        FB.getLoginStatus(function (response) {
          statusChangeCallback(response);
        });
      }


      window.fbAsyncInit = function() {
        document.getElementById('wait-for-fb').style.display = 'none';

        var appId = '317751075269036';
        var localAppId = '320008228376654';

        FB.init({
          appId      : location.hostname == 'localhost' ? localAppId : appId,
          xfbml      : true,
          version    : 'v2.8'
        });

        //checkLoginState();
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
  </body>
</html>